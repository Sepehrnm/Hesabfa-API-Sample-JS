<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title> ذخیره حواله انبار</title>
    <link rel="stylesheet" href="../style.css">
    <script src="../API.js" type="text/javascript"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.7/dist/umd/popper.min.js" integrity="sha384-zYPOMqeu1DAVkHiLqWBUTcbYfZ8osu1Nd6Z89ify25QV9guujx43ITvfi12/QExE" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.min.js" integrity="sha384-Y4oOpwW3duJdCWv5ly8SCFYWqFDsfob/3GkgExXKV4idmbt98QcxXYs9UoXAB7BZ" crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js" integrity="sha384-vFJXuSJphROIrBnz7yo7oB41mKfc8JzQZiCq4NCceLEaO4IHwicKwpJf9c9IpFgh" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js" integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ" crossorigin="anonymous"></script>
    <link rel="icon" href="../Assets/hesabfaIcon.png">
</head>
<body>
<script>
    var i = 2;
</script>
<nav>
    <ul>
        <li>
            <img style="width: 40px;height: 40px" src="../Assets/hesabfaIcon.png" alt="hesabfaIcon">
            <img style="width: 70px;height: 60px" src="../Assets/hesabfa-logo.png" alt="logo">
        </li>

        <li class="home-list">
            <a href="../index.html">خانه</a>
        </li>

        <li class="home-list">
            <a href="../errors.html">جدول کدهای خطا</a>
        </li>

        <li class="dropdown">
            <button class="dropbtn">متد های کالاها و خدمات</button>
            <div class="dropdown-content">
                <a href="../Items/getItem.html">دریافت</a>
                <a href="../Items/saveItem.html">ذخیره</a>
                <a href="../Items/getItemByBarCode.html">دریافت از طریق بارکد</a>
                <a href="../Items/getItemById.html">دریافت از طریق Id</a>
                <a href="../Items/getItems.html">دریافت لیست</a>
                <a href="../Items/deleteItem.html">حذف</a>
                <a href="../Items/getItemQuantity.html">لیست موجودی کالاها</a>
                <a href="../Items/updateItemOpeningQuantity.html">به روز رسانی موجودی اول دوره کالاها</a>
            </div>
        </li>

        <li class="dropdown">
            <button class="dropbtn">متد های فاکتور</button>
            <div class="dropdown-content">
                <a href="../Invoices/saveInvoice.html">ذخیره فاکتور</a>
                <a href="../Invoices/deleteInvoice.html">حذف فاکتور</a>
                <a href="../Invoices/getInvoices.html">دریافت لیست</a>
                <a href="../Invoices/getInvoice.html">دریافت فاکتور</a>
                <a href="../Invoices/savePayment.html"> ثبت دریافت و پرداخت فاکتور</a>
                <a href="../Invoices/getInvoiceById.html">دریافت از طریق Id</a>
                <a href="../Invoices/getOnlineInvoiceURL.html">دریافت URL فاکتور آنلاین</a>
                <a href="../Invoices/saveWarehouseReceipt.html">ذخیره حواله انبار</a>
            </div>
        </li>

        <li class="dropdown">
            <button class="dropbtn">متد های اشخاص</button>
            <div class="dropdown-content">
                <a href="../Contacts/getContact.html">دریافت</a>
                <a href="../Contacts/getContacts.html">دریافت لیست</a>
                <a href="../Contacts/getContactById.html">دریافت از طریق Id</a>
                <a href="../Contacts/saveContact.html">ذخیره</a>
                <a href="../Contacts/deleteContact.html">حذف</a>
                <a href="../Contacts/getContactLink.html">لینک کارت حساب</a>
            </div>
        </li>

        <li class="dropdown">
            <button class="dropbtn">متد های دریافت و پرداخت</button>
            <div class="dropdown-content">
                <a href="../Receive%20Pay/getReceipts.html">نمایش لیست رسیدهای دریافت یا پرداخت</a>
                <a href="../Receive%20Pay/getReceipt.html">دریافت رسید دریافت یا پرداخت</a>
                <a href="../Receive%20Pay/getByID.html">دریافت رسید دریافت و پرداخت از طریق Id</a>
                <a href="../Receive%20Pay/saveReceipt.html">ذخیره رسید</a>
                <a href="../Receive%20Pay/deleteReceipt.html">حذف رسید</a>
            </div>
        </li>

        <li class="dropdown">
            <button class="dropbtn">متد های رسید و حواله انبار</button>
            <div class="dropdown-content">
                <a href="../Warehouse/getWarehouseReceipt.html">دریافت</a>
                <a href="../Warehouse/getWarehouseReceiptById.html">دریافت از طریق ID</a>
                <a href="../Warehouse/getWarehouseReceipts.html">دریافت لیست</a>
                <a href="../Warehouse/saveWarehouseReceipt.html">ذخیره</a>
                <a href="../Warehouse/deleteWarehouseReceipt.html">حذف</a>
            </div>
        </li>

        <li class="dropdown">
            <button class="dropbtn">متد های ثبت سند حسابداری</button>
            <div class="dropdown-content">
                <a href="../Accounting/getDocument.html">دریافت</a>
                <a href="../Accounting/saveDocument.html">ذخیره</a>
                <a href="../Accounting/getDocuments.html">دریافت لیست</a>
                <a href="../Accounting/deleteDocument.html">حذف سند</a>
            </div>
        </li>

        <li class="dropdown">
            <button class="dropbtn">متدهای اقلام تخفیف دار</button>
            <div class="dropdown-content">
                <a href="../DiscountItem/get.html">دریافت</a>
                <a href="../DiscountItem/getByID.html">دریافت از طریق ID</a>
                <a href="../DiscountItem/getList.html">دریافت لیست</a>
                <a href="../DiscountItem/save.html">ذخیره</a>
                <a href="../DiscountItem/delete.html">حذف</a>
            </div>
        </li>

        <li class="dropdown">
            <button class="dropbtn">سایر متدها</button>
            <div class="dropdown-content">
                <a href="../Settings/getChanges.html">دریافت آخرین تغییرات</a>
                <a href="../Settings/getFiscalYears.html">دریافت لیست سال مالی</a>
                <a href="../Settings/getBanks.html">دریافت لیست بانک ها</a>
                <a href="../Settings/getCashes.html">دریافت لیست صندوق ها</a>
                <a href="../Settings/getPettyCashes.html">دریافت لیست تنخواه گردان ها</a>
                <a href="../Settings/getCurrency.html">دریافت واحد پول</a>
                <a href="../Settings/getWarehouses.html">دریافت لیست انبار ها</a>
                <a href="../Settings/getProductCategories.html">دریافت لیست دسته بندی کالا ها</a>
                <a href="../Settings/getServiceCategories.html">دریافت لیست دسته بندی خدمات</a>
                <a href="../Settings/getContactCategories.html">دریافت لیست دسته بندی اشخاص</a>
                <a href="../Settings/getFiscalYear.html">دریافت اطلاعات سال مالی جاری</a>
                <a href="../Settings/getProjects.html">دریافت لیست پروژه ها</a>
                <a href="../Settings/getSalesmen.html">دریافت لیست فروشنده ها</a>
                <a href="../Settings/getCurrencyTable.html">دریافت جدول نرخ برابری ارزها</a>
                <a href="../Settings/setCurrencyTable.html">تنظیم جدول نرخ برابری ارزها</a>
                <a href="../Settings/getAccounts.html">دریافت جدول حساب ها</a>
                <a href="../Settings/getBusinessInfo.html">دریافت اطلاعات کسب و کار</a>
            </div>
        </li>

        <li class="dropdown">
            <button class="dropbtn">متد های دریافت گزارش</button>
            <div class="dropdown-content">
                <a href="../Reports/balancesheet.html">گزارش ترازنامه</a>
                <a href="../Reports/debtorscreditors.html">گزارش بدهکاران و بستانکاران</a>
                <a href="../Reports/profitAndLossStatement.html"> گزارش صورت سود و زیان</a>
                <a href="../Reports/reportInventory.html">گزارش موجودی کالا</a>
                <a href="../Reports/trialBalance.html">گزارش تراز آزمایشی</a>
                <a href="../Reports/trialBalanceItems.html">گزارش آیتم های تفضیلی تراز آزمایشی</a>
                <a href="../Reports/reportBank.html">گزارش گردش حساب بانک</a>
                <a href="../Reports/reportCash.html">گزارش گردش حساب صندوق</a>
                <a href="../Reports/reportPettyCash.html">گزارش گردش حساب گردان</a>
                <a href="../Reports/reportJournal.html">گزارش روزنامه</a>
            </div>
        </li>
    </ul>
</nav>

<div class="container">
    <div class="row">
        <div class="col-12">
            <h3>
                ذخیره حواله انبار
            </h3>
            <br>
            <div id="alert-container"></div>
            <div class="text-danger">
                <strong>نکات ضروری</strong>
                <br>
                با فراخوانی این متد رسید یا حواله انبار برای فاکتور خرید یا فروش صادر می گردد. در صورتی که کالاهای فاکتور در چندین انبار مختلف وجود داشته باشند به ازای هر انبار باید یکبار این متد را فراخوانی کرد و در هر فراخوانی کالاها و تعداد مورد نیاز به تفکیک انبار ذکر گردد.
                <br>
                در صورتی که مقدار پارامتر deleteOldReceipts=true باشد، کلیه حواله های قبلی صادر شده برای فاکتور حذف خواهند شد و حواله جدید صادر می شود.
                <br>
                کلیه آیتم های باید از نوع کالا و با قابلیت کنترل موجودی باشند در غیر اینصورت حواله ثبت نخواهد شد.
            </div>
            <br><br>
            <form method="post" class="save-contact-form">
                <div class="halign">
                    <div class="align">
                        <label for="deleteOldReceipts" class="form-label">حذف رسید یا حواله قدیمی</label>
                        <select name="deleteOldReceipts" id="deleteOldReceipts" class="form-select">
                            <option selected>انتخاب کنید</option>
                            <option value="true">بله</option>
                            <option value="false">خیر</option>
                        </select>
                    </div>
                    <div class="align">
                        <label for="warehouseCode" class="form-label">کد انبار</label>
                        <input type="text" class="form-control" id="warehouseCode">
                    </div>
                    <div class="align">
                        <label for="invoiceNumber" class="form-label">شماره فاکتور</label>
                        <input type="text" class="form-control" id="invoiceNumber">
                    </div>
                    <div class="align">
                        <label for="invoiceType" class="form-label">نوع فاکتور</label>
                        <select name="invoiceType" id="invoiceType" class="form-select">
                            <option selected>انتخاب کنید</option>
                            <option value="0">فروش</option>
                            <option value="1">خرید</option>
                            <option value="2">برگشت از فروش</option>
                            <option value="3">برگشت از خرید</option>
                            <option value="4">ضایعات</option>
                        </select>
                    </div>
                </div>
                <div class="halign">
                    <div class="align">
                        <label for="date" class="form-label">تاریخ حواله</label>
                        <input type="text" class="form-control" id="date">
                    </div>
                    <div class="align">
                        <label for="note" class="form-label">یادداشت و توضیحات</label>
                        <input type="text" class="form-control" id="note">
                    </div>
                    <div class="align">
                        <label for="freight" class="form-label">هزینه حمل</label>
                        <input type="text" class="form-control" id="freight">
                    </div>
                </div>
                <div class="halign">
                    <div class="align">
                        <label for="delivery" class="form-label">تحویل (در محل انبار)</label>
                        <input type="text" class="form-control" id="delivery">
                    </div>
                    <div class="align">
                        <label for="project" class="form-label">پروژه</label>
                        <input type="text" class="form-control" id="project">
                    </div>
                </div>
                <br>
                <table class="table-striped table table-light">
                    <thead>
                    <tr>
                        <th>
                            کد کالا
                            <span style="color: red;font-size: 1.2rem;">*</span>
                        </th>
                        <th>
                            تعداد
                            <span style="color: red;font-size: 1.2rem;">*</span>
                        </th>
                        <th>
                            ارجاع
                        </th>
                        <th>
                            توضیحات
                        </th>
                    </tr>
                    </thead>
                    <tbody class="quantity-tbody">
                    <tr>
                        <td>
                            <input type="hidden" value="1" name="counter" class="counter">
                            <input class="accounting-input" type="text" id="itemCode1" required />
                        </td>
                        <td>
                            <input type="text" id="quantity1" required />
                        </td>
                        <td>
                            <input type="text" id="reference1" />
                        </td>
                        <td>
                            <input type="text" id="note1" />
                        </td>
                    </tr>
                    </tbody>
                </table>
                <div id="buttons-container" style="justify-content: flex-end;">
                    <button id="deleteRow" class="deleteRow btn btn-danger m-2"><span class="m-2">-</span>حذف ردیف</button>
                    <button id="addNewRow" class="addNewRow btn btn-secondary m-2"><span class="m-2">+</span>افزودن ردیف</button>
                </div>
                <br>
                <button class="btn btn-primary" onclick="saveWarehouseReceiptFunction()">ذخیره</button>
            </form>
        </div>
    </div>
</div>
<script type='text/javascript'>
    function init() {
        $('button.dropbtn').on('click', (e) => {
            $(".dropdown-content").slideUp();
            $(e.target).next().stop().slideToggle();
        });
    }

    $( document ).ready(() => {
        init();
    });

    var path = window.location.href.substring(window.location.href.lastIndexOf('API') + 4);
    $('a[href="../' + path + '"]').parent().slideDown();
</script>
<script type="text/javascript">
    $(document).ready(() => {
        $("#addNewRow").on('click', (e) => {
            e.preventDefault();
            let element = `
                <tr id="element-${i}">
                    <input type="hidden" value="${i}" class="counter">
                    <td><input type="text" id="itemCode${i}" class="accounting-input" required /></td>
                    <td><input type="text" id="quantity${i}" required /></td>
                    <td><input type="text" id="reference${i}" required /></td>
                    <td><input type="text" id="note${i}" /></td>
                </tr>`;
            ++i;
            $(".quantity-tbody").append(element);
        });

        $("#deleteRow").on('click', (e) => {
            e.preventDefault();
            if(i>2) {
                $(`.quantity-tbody`).children().last().remove();
                i--;
            }
        });
    });
</script>
<script type="text/javascript">
    $('button').on('click', (e) => e.preventDefault());
    async function saveWarehouseReceiptFunction() {
        const deleteOldReceipts = document.getElementById('deleteOldReceipts').value;
        const warehouseCode = document.getElementById('warehouseCode').value;
        const invoiceNumber = document.getElementById('invoiceNumber').value;
        const invoiceType = document.getElementById('invoiceType').value;
        const date = document.getElementById('date').value;
        const note = document.getElementById('note').value;
        const freight = document.getElementById('freight').value;
        const delivery = document.getElementById('delivery').value;
        const project = document.getElementById('project').value;

        // let counter = $('.counter').val();
        let counter = i;

        let data;
        let item;
        let items = [];
        for(let j = 1 ; j < counter ; j++) {
            let itemCode = document.getElementById(`itemCode${j}`).value;
            let quantity = document.getElementById(`quantity${j}`).value;
            let reference = document.getElementById(`reference${j}`).value;
            let note = document.getElementById(`note${j}`).value;

            item = {
                'ItemCode': itemCode,
                'Quantity': quantity,
                'Reference': reference,
                'Notes': note
            }

            items.push(item);
        }
        data = {
            'deleteOldReceipts': deleteOldReceipts,
            'receipt':{
                'WarehouseCode': warehouseCode,
                'InvoiceNumber': invoiceNumber,
                'InvoiceType': invoiceType,
                'Date': date,
                'Notes': note,
                'Freight': freight,
                'Delivery': delivery,
                'Project': project,
                'Items': items
            }
        };
        const response = await saveWarehouseReceipt(data);

        if(response.Success) {
            $('#alert-container').html(`
                <div class="alert alert-success" role="alert">
                  ذخیره گردید
                </div>
            `)
        } else {
            $('#alert-container').html(`
                <div class="alert alert-danger" role="alert" style="direction: ltr;">
                    ErrorCode: ${response.ErrorCode}
                    <br>
                    ErrorMessage: ${response.ErrorMessage}
                </div>
            `)
        }
    }
</script>
</body>
</html>