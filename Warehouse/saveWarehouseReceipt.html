<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ذخیره</title>
    <script src="../jQuery.js"></script>
</head>
<body>
<div id="includedContent"></div>
<script src="../linksPartial.js"></script>
<script src="../API.js" type="text/javascript"></script>

<script>
    var i = 2;
</script>
<div class="container">
    <div class="row">
        <div class="col-12">
            <h4>
                ذخیره
            </h4>
            <br>
            <div id="alert-container"></div>
            <div class="alert alert-warning">
                <div>
                    با فراخوانی این متد رسید یا حواله انبار برای فاکتور خرید یا فروش صادر می گردد. در صورتی که کالاهای فاکتور در چندین انبار مختلف وجود داشته باشند به ازای هر انبار باید یکبار این متد را فراخوانی کرد و در هر فراخوانی کالاها و تعداد مورد نیاز به تفکیک انبار ذکر گردد.
                </div>
                <br>
                <div>
                    در صورتی که مقدار پارامتر deleteOldReceipts=true باشد، کلیه حواله های قبلی صادر شده برای فاکتور حذف خواهند شد و حواله جدید صادر می شود.
                </div>
                <br>
                <div>
                    کلیه آیتم های باید از نوع کالا و با قابلیت کنترل موجودی باشند در غیر اینصورت حواله ثبت نخواهد شد.
                </div>
                <br>
                <div>
                    در صورتی که فیلد DestinationWarehouseCode(کد حواله انتقال) دارای مقدار باشد، فیلدهای شماره و نوع فاکتور نادیده گرفته می شوند و حواله انتقال صادر خواهد شد.
                </div>
            </div>

            <form method="post" class="save-form">
                <div class="halign">
                    <div class="align">
                        <label for="deleteOldReceipts" class="form-label">حذف رسید یا حواله قدیمی</label>
                        <select name="deleteOldReceipts" id="deleteOldReceipts" class="form-select">
                            <option value="false" selected>انتخاب کنید</option>
                            <option value="true">بله</option>
                            <option value="false">خیر</option>
                        </select>
                    </div>
                    <div class="align">
                        <label for="warehouseCode" class="form-label">کد انبار</label>
                        <input type="text" class="form-control" id="warehouseCode">
                    </div>
                    <div class="align">
                        <label for="invoiceNumber" class="form-label">شماره فاکتور</label>
                        <input type="text" class="form-control" id="invoiceNumber">
                    </div>
                    <div class="align">
                        <label for="invoiceType" class="form-label">نوع فاکتور</label>
                        <select name="invoiceType" id="invoiceType" class="form-select">
                            <option value="-1" selected>انتخاب کنید</option>
                            <option value="0">فروش</option>
                            <option value="1">خرید</option>
                            <option value="2">برگشت از فروش</option>
                            <option value="3">برگشت از خرید</option>
                            <option value="4">ضایعات</option>
                        </select>
                    </div>
                </div>
                <div class="halign">
                    <div class="align">
                        <label for="date" class="form-label">تاریخ حواله</label>
                        <input type="text" class="form-control" id="date">
                    </div>
                    <div class="align">
                        <label for="notes" class="form-label">یادداشت و توضیحات</label>
                        <input type="text" class="form-control" id="notes">
                    </div>
                    <div class="align">
                        <label for="freight" class="form-label">هزینه حمل</label>
                        <input type="text" class="form-control" id="freight">
                    </div>
                    <div class="align">
                        <label for="DestinationWarehouseCode" class="form-label">کد حواله انتقال</label>
                        <input type="text" class="form-control" id="DestinationWarehouseCode">
                    </div>
                </div>
                <div class="halign">
                    <div class="align">
                        <label for="delivery" class="form-label">تحویل (در محل انبار)</label>
                        <input type="text" class="form-control" id="delivery">
                    </div>
                    <div class="align">
                        <label for="project" class="form-label">پروژه</label>
                        <input type="text" class="form-control" id="project">
                    </div>
                </div>
                <br>
                <table class="table-striped table table-light">
                    <thead>
                    <tr>
                        <th>
                            کد کالا
                            <span style="color: red;font-size: 1.2rem;">*</span>
                        </th>
                        <th>
                            تعداد
                            <span style="color: red;font-size: 1.2rem;">*</span>
                        </th>
                        <th>
                            ارجاع
                        </th>
                        <th>
                            توضیحات
                        </th>
                    </tr>
                    </thead>
                    <tbody class="quantity-tbody">
                    <tr>
                        <td>
                            <input type="hidden" value="1" name="counter" class="counter">
                            <input class="accounting-input" type="text" id="itemCode1" required />
                        </td>
                        <td>
                            <input type="text" id="quantity1" required />
                        </td>
                        <td>
                            <input type="text" id="reference1" />
                        </td>
                        <td>
                            <input type="text" id="notes1" />
                        </td>
                    </tr>
                    </tbody>
                </table>
                <div id="buttons-container" style="justify-content: flex-end;">
                    <button id="deleteRow" class="deleteRow btn btn-danger m-2"><span class="m-2">-</span>حذف ردیف</button>
                    <button id="addNewRow" class="addNewRow btn btn-secondary m-2"><span class="m-2">+</span>افزودن ردیف</button>
                </div>
                <br>
                <button class="btn btn-success" onclick="saveWarehouseReceiptFunction()">ذخیره</button>
            </form>
        </div>
    </div>
</div>

<script type='text/javascript'>
    function init() {
        $('button.dropbtn').on('click', (e) => {
            $(".dropdown-content").slideUp();
            $(e.target).next().stop().slideToggle();
        });
    }

    $( document ).ready(() => {
        init();
    });

    var path = window.location.href.substring(window.location.href.lastIndexOf('API') + 4);
    $('a[href="../' + path + '"]').parent().slideDown();
</script>
<script type="text/javascript">
    $(document).ready(() => {
        $("#addNewRow").on('click', (e) => {
            e.preventDefault();
            let element = `
                <tr id="element-${i}">
                    <input type="hidden" value="${i}" class="counter">
                    <td><input type="text" id="itemCode${i}" class="accounting-input" required /></td>
                    <td><input type="text" id="quantity${i}" required /></td>
                    <td><input type="text" id="reference${i}" /></td>
                    <td><input type="text" id="notes${i}" /></td>
                </tr>`;
            ++i;
            $(".quantity-tbody").append(element);
        });

        $("#deleteRow").on('click', (e) => {
            e.preventDefault();
            if(i>2) {
                $(`.quantity-tbody`).children().last().remove();
                i--;
            }
        });
    });

    $('button').on('click', (e) => e.preventDefault());
    async function saveWarehouseReceiptFunction() {
        const warehouseCode = document.getElementById('warehouseCode').value;
        const invoiceNumber = document.getElementById('invoiceNumber').value;
        const invoiceType = document.getElementById('invoiceType').value;
        const date = document.getElementById('date').value;

        let counter = i;

        let data;
        let item;
        let items = [];
        for(let j = 1 ; j < counter ; j++) {
            let itemCode = document.getElementById(`itemCode${j}`).value;
            let quantity = document.getElementById(`quantity${j}`).value;

            item = {
                'ItemCode': itemCode,
                'Quantity': quantity,
            }

            if($(`#reference${j}`).val()) item.Reference = $(`#reference${j}`).val();
            if($(`#notes${j}`).val()) item.Notes = $(`#notes${j}`).val();

            items.push(item);
        }

        data = {
            'receipt':{
                'WarehouseCode': warehouseCode,
                'DestinationWarehouseCode': $("#DestinationWarehouseCode").val(),
                'InvoiceNumber': invoiceNumber,
                'InvoiceType': invoiceType,
                'Date': date,
                'Items': items
            }
        };

        function assignValue(key, value) {
            if($(`#${key}`).val()) {
                data.receipt[key] = value;
            }
        }

        assignValue("Project", project);
        assignValue("Delivery", delivery);
        assignValue("Freight", freight);
        assignValue("Notes", notes);

        if($("#deleteOldReceipts").val()) data.deleteOldReceipts = $("#deleteOldReceipts").val();

        const response = await warehouseSaveWarehouseReceipt(data);

        if(response.Success) {
            $('#alert-container').html(`
                <div class="alert alert-success" role="alert">
                  ذخیره گردید
                </div>
            `)
        } else {
            $('#alert-container').html(`
                <div class="alert alert-danger" role="alert" style="direction: ltr;">
                    ErrorCode: ${response.ErrorCode}
                    <br>
                    ErrorMessage: ${response.ErrorMessage}
                </div>
            `)
        }
    }
</script>
</body>
</html>